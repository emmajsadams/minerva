#!/bin/sh
echo "🚀 Running post-commit deployment..."

# Get the current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "📋 Current branch: $BRANCH"

# Only deploy from main branch to avoid unnecessary deployments
if [ "$BRANCH" != "main" ]; then
  echo "⏭️  Skipping deployment - not on main branch"
  exit 0
fi

# Check if we're in a CI environment (skip if so)
if [ "$CI" = "true" ]; then
  echo "⏭️  Skipping deployment - running in CI environment"
  exit 0
fi

# Deploy Convex first (backend)
echo "🔧 Deploying Convex backend..."
if convex deploy; then
  echo "✅ Convex deployment successful!"
else
  echo "❌ Convex deployment failed - aborting Vercel deployment"
  exit 1
fi

echo ""

# Deploy to Vercel production
echo "🌍 Deploying to Vercel production..."
vercel deploy --prod --prebuilt=false --yes 2>&1 | tee /tmp/vercel-deploy.log

# Check if deployment was successful
if [ $? -eq 0 ]; then
  # Extract production URL from deployment output
  PRODUCTION_URL=$(grep -o 'https://[^[:space:]]*\.vercel\.app' /tmp/vercel-deploy.log | tail -1)
  
  if [ -n "$PRODUCTION_URL" ]; then
    echo "✅ Production deployment successful!"
    echo "🔗 Production URL: $PRODUCTION_URL"
    echo "🎉 Both Convex and Vercel deployments completed successfully"
    
    # Optional: Open URL in browser (uncomment if desired)
    # open "$PRODUCTION_URL" 2>/dev/null || true
  else
    echo "✅ Production deployment completed (URL not captured)"
  fi
else
  echo "❌ Vercel deployment failed - check output above"
  echo "💡 Note: Convex was deployed successfully, but Vercel failed"
fi

# Clean up
rm -f /tmp/vercel-deploy.log

echo ""
echo "📝 Post-commit deployment complete!"
echo "🔍 Both backend (Convex) and frontend (Vercel) are now in sync"